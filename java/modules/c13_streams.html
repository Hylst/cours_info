<section id="c13">
    <div class="container">
        <div class="sec-header">
            <div class="sec-num">13</div>
            <div>
                <h2 class="sec-title">Streams API</h2>
                <p class="sec-sub">Programmation Fonctionnelle & Pipelines</p>
            </div>
        </div>

        <!-- Introduction -->
        <div class="callout callout-info">
            <h4>üéì Avant de Commencer</h4>
            <p><strong>Pr√©requis</strong> : Collections (C12) et Lambdas (C8).</p>
            <p><strong>Ce que vous allez apprendre</strong> : Comment traiter des millions de donn√©es de mani√®re
                d√©clarative (SQL-like) sans √©crire une seule boucle <code>for</code>.</p>
            <p><strong>Temps de lecture</strong> : ~20 minutes | <strong>Niveau</strong> : ‚≠ê‚≠ê‚≠ê‚≠ê</p>
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">üåä Le Pipeline Stream</h3>
        <p>Un Stream n'est pas une structure de donn√©es, c'est un <strong>flux</strong> de donn√©es. Il ne stocke rien.
            Il prend une source, applique des transformations, et produit un r√©sultat.</p>

        <!-- Diagram -->
        <div class="diagram-container">
            <div class="mermaid">
                flowchart LR
                Source[(Source<br />List, Set, I/O)] -->|stream()| Op1[Intermediate<br />filter, map]
                Op1 -->|Intermediate| Op2[Intermediate<br />sorted, distinct]
                Op2 -->|Terminal| Term[Terminal<br />collect, count, forEach]

                style Source fill:#1c2128,stroke:#ffa94d,color:#f0f6fc
                style Op1 fill:#161b22,stroke:#79c0ff,color:#f0f6fc
                style Op2 fill:#161b22,stroke:#79c0ff,color:#f0f6fc
                style Term fill:#3fb950,stroke:#3d444d,color:#0d1117
            </div>
            <p style="margin-top:10px; font-size:0.9rem; color: var(--text-muted-foreground);">Lazy Evaluation : Rien ne
                se passe tant qu'une op√©ration TERMINALE n'est pas appel√©e.</p>
        </div>

        <!-- Operations Table -->
        <h3 style="margin-top: 2.5rem; margin-bottom: 1rem;">üõ†Ô∏è Les Op√©rations Cl√©s</h3>
        <div style="overflow-x:auto;">
            <table>
                <tr>
                    <th>Op√©ration</th>
                    <th>Type</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><code>filter(Pred)</code></td>
                    <td>Interm√©diaire</td>
                    <td>Garde seulement ce qui match (comme `WHERE` en SQL)</td>
                </tr>
                <tr>
                    <td><code>map(Func)</code></td>
                    <td>Interm√©diaire</td>
                    <td>Transforme chaque √©l√©ment (Ex: User ‚Üí String name)</td>
                </tr>
                <tr>
                    <td><code>flatMap(Func)</code></td>
                    <td>Interm√©diaire</td>
                    <td>Aplatit des structures imbriqu√©es (List&lt;List&gt; ‚Üí List)</td>
                </tr>
                <tr>
                    <td><code>sorted()</code></td>
                    <td>Interm√©diaire</td>
                    <td>Trie le flux (Attention : co√ªteux)</td>
                </tr>
                <tr>
                    <td><code>distinct()</code></td>
                    <td>Interm√©diaire</td>
                    <td>Supprime les doublons (utilise equals)</td>
                </tr>
                <tr>
                    <td><code>collect()</code></td>
                    <td><strong>Terminal</strong></td>
                    <td>Transforme le stream en List, Map, Set...</td>
                </tr>
                <tr>
                    <td><code>findFirst()</code></td>
                    <td><strong>Terminal</strong></td>
                    <td>Retourne un `Optional` (Court-circuit)</td>
                </tr>
            </table>
        </div>

        <!-- Code Examples -->
        <h3 style="margin-top: 2.5rem; margin-bottom: 1rem;">üíª Exemples Concrets</h3>

        <div class="grid2">
            <div class="code">
                <div class="code-head"><span class="dot g"></span>Map & Filter & Collect</div>
                <pre><span class="type">List</span>&lt;<span class="type">User</span>&gt; <span class="var">users</span> = <span class="mt">getUsers</span>();

<span class="type">List</span>&lt;<span class="type">String</span>&gt; <span class="var">names</span> = <span class="var">users</span>.<span class="mt">stream</span>()
    .filter(<span class="var">u</span> -> <span class="var">u</span>.<span class="mt">getAge</span>() > <span class="num">18</span>)
    .map(<span class="type">User</span>::<span class="mt">getName</span>)
    .map(<span class="type">String</span>::<span class="mt">toUpperCase</span>)
    .sorted()
    .limit(<span class="num">5</span>)
    .collect(<span class="type">Collectors</span>.<span class="mt">toList</span>());</pre>
            </div>
            <div class="code">
                <div class="code-head"><span class="dot b"></span>Stats & Reduction</div>
                <pre><span class="type">List</span>&lt;<span class="type">Integer</span>&gt; <span class="var">prices</span> = <span class="type">List</span>.<span class="mt">of</span>(<span class="num">10</span>, <span class="num">20</span>, <span class="num">30</span>);

<span class="com">// Somme simple</span>
<span class="kw">int</span> <span class="var">sum</span> = <span class="var">prices</span>.<span class="mt">stream</span>()
    .mapToInt(<span class="type">Integer</span>::<span class="mt">intValue</span>)
    .sum();

<span class="com">// R√©duction personnalis√©e</span>
<span class="kw">int</span> <span class="var">product</span> = <span class="var">prices</span>.<span class="mt">stream</span>()
    .reduce(<span class="num">1</span>, (<span class="var">a</span>, <span class="var">b</span>) -> <span class="var">a</span> * <span class="var">b</span>);</pre>
            </div>
        </div>

        <!-- FlatMap -->
        <h3 style="margin-top: 2.5rem; margin-bottom: 1rem;">ü•û FlatMap : Aplatir le Flux</h3>
        <p>Utilis√© quand chaque √©l√©ment g√©n√®re PLUSIEURS r√©sultats (Relation 1-N).</p>
        <div class="code">
            <div class="code-head"><span class="dot r"></span>Exemple : Commandes -> Produits</div>
            <pre><span class="type">List</span>&lt;<span class="type">Order</span>&gt; <span class="var">orders</span> = <span class="mt">getOrders</span>(); 
<span class="com">// Chaque Order a une List&lt;Product&gt;</span>

<span class="type">List</span>&lt;<span class="type">Product</span>&gt; <span class="var">allProducts</span> = <span class="var">orders</span>.<span class="mt">stream</span>()
    .flatMap(<span class="var">o</span> -> <span class="var">o</span>.<span class="mt">getProducts</span>().<span class="mt">stream</span>()) <span class="com">// Stream&lt;List&gt; -> Stream&lt;Product&gt;</span>
    .collect(<span class="type">Collectors</span>.<span class="mt">toList</span>());</pre>
        </div>

        <!-- Parallel Streams -->
        <h3 style="margin-top: 2.5rem; margin-bottom: 1rem;">üöÄ Parallel Streams</h3>
        <div class="callout callout-warning">
            <h4>‚ö†Ô∏è √Ä utiliser avec pr√©caution !</h4>
            <p><code>stream().parallel()</code> divise le travail sur plusieurs c≈ìurs CPU (ForkJoinPool).</p>
            <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                <li><strong>G√©nial pour</strong> : Calculs CPU intensifs sur de tr√®s grosses listes (> 10k √©l√©ments).
                </li>
                <li><strong>Mauvais pour</strong> : Op√©rations simples (le co√ªt de coordination d√©passe le gain) ou
                    bloquantes (I/O).</li>
                <li><strong>Danger</strong> : Si votre op√©ration a des effets de bord (modifier une liste partag√©e),
                    vous aurez des bugs de concurrence al√©atoires !</li>
            </ul>
        </div>

        <!-- Le Saviez-vous -->
        <div class="callout callout-recall" style="margin-top: 2rem;">
            <h4>üí° Le Saviez-vous ?</h4>
            <p><strong>Lazy Evaluation</strong> : <code>filter()</code> ne parcourt pas toute la liste si vous avez un
                <code>findFirst()</code> derri√®re. Il s'arr√™te d√®s qu'il a trouv√© !</p>
            <p style="margin-top: 0.75rem;"><strong>Reuse is forbiden</strong> : Un Stream ne s'utilise qu'une seule
                fois. Si vous appelez une m√©thode terminale, le stream est ferm√©. R√©essayez et vous aurez une
                <code>IllegalStateException</code>.</p>
            <p style="margin-top: 0.75rem;"><strong>Debug</strong> : Difficile de debuguer une cha√Æne de 10 map/filter ?
                Utilisez <code>.peek(System.out::println)</code> pour voir passer les √©l√©ments sans modifier le flux.
            </p>
        </div>

        <!-- Cas d'Usage -->
        <div class="use-case" style="margin-top: 2rem;">
            <h4>üìä Cas R√©el : Grouping By (SQL like)</h4>
            <p>On veut grouper les utilisateurs par Ville.</p>
            <div class="code" style="margin-top: 1rem;">
                <div class="code-head"><span class="dot b"></span>Collectors.groupingBy</div>
                <pre><span class="type">Map</span>&lt;<span class="type">String</span>, <span class="type">List</span>&lt;<span class="type">User</span>&gt;&gt; <span class="var">byCity</span> = <span class="var">users</span>.<span class="mt">stream</span>()
    .collect(<span class="type">Collectors</span>.<span class="mt">groupingBy</span>(<span class="type">User</span>::<span class="mt">getCity</span>));

<span class="com">// R√©sultat : { "Paris": [u1, u3], "Lyon": [u2] }</span></pre>
            </div>
        </div>

    </div>
</section>