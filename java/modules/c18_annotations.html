<section id="c18">
    <div class="container">
        <div class="sec-header">
            <div class="sec-num">18</div>
            <div>
                <h2 class="sec-title">Annotations & Reflection</h2>
                <p class="sec-sub">La Magie des Frameworks</p>
            </div>
        </div>

        <!-- Introduction -->
        <div class="callout callout-info">
            <h4>üéì Avant de Commencer</h4>
            <p><strong>Quoi ?</strong> : Les m√©tadonn√©es (Annotations) et la capacit√© d'examiner/modifier le code au
                moment de l'ex√©cution (R√©flexion).</p>
            <p><strong>Pourquoi ?</strong> : C'est la base de Spring, Hibernate, JUnit, Jackson. Comprendre √ßa, c'est
                comprendre comment "la magie" fonctionne.</p>
            <p><strong>Temps de lecture</strong> : ~20 minutes | <strong>Niveau</strong> : ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</p>
        </div>

        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">üè∑Ô∏è Les Annotations</h3>
        <p>Ce ne sont que des √©tiquettes coll√©es sur le code. Par d√©faut, <strong>elles ne font rien</strong>. Il faut
            un outil (R√©flexion ou Processeur) pour les lire.</p>

        <div class="code">
            <div class="code-head"><span class="dot g"></span>D√©finir une Annotation</div>
            <pre><span class="man">@Retention</span>(<span class="type">RetentionPolicy</span>.<span class="const">RUNTIME</span>) <span class="com">// Visible au runtime</span>
<span class="man">@Target</span>(<span class="type">ElementType</span>.<span class="const">METHOD</span>)         <span class="com">// Sur m√©thode uniquement</span>
<span class="kw">public @interface</span> <span class="type">LogExecution</span> {
    <span class="com">// Param√®tres optionnels</span>
    <span class="type">String</span> <span class="mt">level</span>() <span class="kw">default</span> <span class="str">"INFO"</span>;
}

<span class="com">// Utilisation</span>
<span class="kw">class</span> <span class="type">Service</span> {
    <span class="man">@LogExecution</span>(<span class="var">level</span>=<span class="str">"DEBUG"</span>)
    <span class="kw">public void</span> <span class="mt">process</span>() { ... }
}</pre>
        </div>

        <!-- Reflection -->
        <h3 style="margin-top: 2.5rem; margin-bottom: 1rem;">ü™û La R√©flexion (Introspection)</h3>
        <p>Le <strong>Miroir magique</strong> : Java peut se regarder lui-m√™me. Vous pouvez lister les m√©thodes d'une
            classe, appeler des m√©thodes priv√©es, cr√©er des objets dynamiquement.</p>

        <div class="code">
            <div class="code-head"><span class="dot b"></span>Un mini-framework de test</div>
            <pre><span class="kw">public void</span> <span class="mt">runTests</span>(<span class="type">Object</span> <span class="var">obj</span>) <span class="kw">throws</span> <span class="type">Exception</span> {
    <span class="type">Class</span>&lt;?&gt; <span class="var">clazz</span> = <span class="var">obj</span>.<span class="mt">getClass</span>();
    
    <span class="com">// Parcourir toutes les m√©thodes</span>
    <span class="kw">for</span> (<span class="type">Method</span> <span class="var">m</span> : <span class="var">clazz</span>.<span class="mt">getDeclaredMethods</span>()) {
        
        <span class="com">// V√©rifier si l'annotation est pr√©sente</span>
        <span class="kw">if</span> (<span class="var">m</span>.<span class="mt">isAnnotationPresent</span>(<span class="type">Test</span>.<span class="kw">class</span>)) {
            <span class="type">System</span>.out.println(<span class="str">"Running "</span> + <span class="var">m</span>.<span class="mt">getName</span>());
            
            <span class="com">// Rendre accessible si private !</span>
            <span class="var">m</span>.<span class="mt">setAccessible</span>(<span class="kw">true</span>);
            
            <span class="com">// Ex√©cuter la m√©thode (invoke)</span>
            <span class="var">m</span>.<span class="mt">invoke</span>(<span class="var">obj</span>);
        }
    }
}</pre>
        </div>

        <!-- Diagram -->
        <div class="diagram-container">
            <div class="mermaid">
                flowchart LR
                Source[Code Java] -->|Compile| Bytecode[.class]
                Bytecode -->|Load| JVM[JVM Runtime]

                CodeUse[Code Normal] -->|Appel Direct| JVM
                Reflect[R√©flexion] -->|Appel Dynamique| Meta[M√©tadonn√©es<br />Class
                <?>, Method, Field]
                Meta -->|Invoke| JVM
                
                style Source fill:#1c2128,stroke:#f0f6fc,color:#f0f6fc
                style Reflect fill:#ffa94d,stroke:#f0f6fc,color:#0d1117
                style CodeUse fill:#79c0ff,stroke:#f0f6fc,color:#f0f6fc
            </div>
            <p style="margin-top:10px; font-size:0.9rem; color: var(--text-muted-foreground);">La r√©flexion ajoute une couche d'indirection (M√©tadonn√©es), ce qui a un co√ªt.</p>
        </div>

        <!-- Performance & Safety -->
        <div class="grid2" style="margin-top: 2rem;">
            <div class="callout callout-warning">
                <h4>‚ö†Ô∏è Co√ªt de Performance</h4>
                <p>La r√©flexion est beaucoup plus lente que les appels directs.</p>
                <ul>
                    <li>Pas d'optimisation JIT (inlining)</li>
                    <li>V√©rifications de s√©curit√© √† chaque appel</li>
                    <li>Boxing/Unboxing des primitives</li>
                </ul>
                <p><strong>Conseil</strong> : Utilisez-la au d√©marrage (configuration) mais √©vitez-la dans la boucle principale.</p>
            </div>
            <div class="callout callout-danger">
                <h4>‚õî Rupture d'Encapsulation</h4>
                <p><code>setAccessible(true)</code> permet de modifier des champs <code>private final</code>. C'est puissant mais dangereux.</p>
                <p>Avec les <strong>Modules Java 9+</strong>, cette "ouverture" est restreinte. Le code qui abuse de la r√©flexion peut casser lors d'une mise √† jour Java.</p>
            </div>
        </div>

        <!-- Cas d'Usage -->
        <div class="use-case" style="margin-top: 2rem;">
            <h4>üöÄ Cas R√©el : JSON Serializer</h4>
            <div class="code" style="margin-top: 1rem;">
                <div class="code-head"><span class="dot r"></span>ToJson Simplifi√©</div>
                <pre><span class="kw">public String</span> <span class="mt">toJson</span>(<span class="type">Object</span> <span class="var">o</span>) <span class="kw">throws</span> <span class="type">Exception</span> {
    <span class="type">StringBuilder</span> <span class="var">json</span> = <span class="kw">new</span> <span class="type">StringBuilder</span>(<span class="str">"{"</span>);
    
    <span class="kw">for</span> (<span class="type">Field</span> <span class="var">f</span> : <span class="var">o</span>.<span class="mt">getClass</span>().<span class="mt">getDeclaredFields</span>()) {
        <span class="var">f</span>.<span class="mt">setAccessible</span>(<span class="kw">true</span>);
        <span class="kw">if</span> (<span class="var">f</span>.<span class="mt">isAnnotationPresent</span>(<span class="type">JsonIgnore</span>.<span class="kw">class</span>)) <span class="kw">continue</span>;
        
        <span class="var">json</span>.append(<span class="str">"\""</span>).append(<span class="var">f</span>.<span class="mt">getName</span>()).append(<span class="str">"\": \""</span>)
            .append(<span class="var">f</span>.<span class="mt">get</span>(<span class="var">o</span>)).append(<span class="str">"\","</span>);
    }
    
    <span class="kw">return</span> <span class="var">json</span>.append(<span class="str">"}"</span>).toString();
}</pre>
            </div>
        </div>

    </div>
</section>