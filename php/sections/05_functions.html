<div class="sec-header">
    <div class="sec-num">04</div>
    <div>
        <h2 class="sec-title">Les Fonctions</h2>
        <p class="sec-sub">D√©coupage, Typage et Modernit√© : Le secret du code maintenable</p>
    </div>
</div>

<div class="intro-box">
    <p>Une fonction est un bloc de code r√©utilisable. Pourquoi les utiliser ? Pour respecter le principe
        <strong>DRY</strong> (<em>Don't Repeat Yourself</em>). Si vous √©crivez deux fois la m√™me logique, cr√©ez une
        fonction !</p>
</div>

<div class="info">
    <strong>üéØ Objectif du module</strong><br>
    Comprendre une fonction comme un <strong>contrat</strong> : entr√©e claire, sortie pr√©visible, responsabilit√© unique.
</div>

<details>
    <summary>üìñ Quand cr√©er une fonction ?</summary>
    <div>
        <ul>
            <li>Quand une logique revient au moins deux fois.</li>
            <li>Quand un bloc devient difficile √† lire en une seule vue.</li>
            <li>Quand vous voulez tester une logique sans lancer toute l'application.</li>
            <li>Quand vous avez besoin de nommer clairement une intention m√©tier.</li>
        </ul>
    </div>
</details>

<!-- PARTIE 1 : ANATOMIE & ANALOGIE -->
<section>
    <h3>1. L'Usine √† Code</h3>
    <div class="grid2">
        <div class="ref-card">
            <h4>üè≠ Analogie : La Machine √† Jus</h4>
            <p>Imaginez une machine :</p>
            <ul>
                <li><strong>Entr√©es ($fruits)</strong> : Vous donnez des pommes ou des oranges.</li>
                <li><strong>Traitement</strong> : La machine presse, filtre et m√©lange.</li>
                <li><strong>Sortie (return)</strong> : Elle vous rend un verre de jus.</li>
            </ul>
        </div>
        <div class="ref-card">
            <pre style="background:transparent; border:none; padding:0; font-size:0.7rem;">
 [ Entr√©e ] -> ( $param√®tres )
      |
 [ Machine ] -> { traitement }
      |
 [ Sortie ] -> return "verre";</pre>
        </div>
    </div>

    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>Basique.php</div>
        <pre><span class="c">// D√©claration</span>
<span class="kw">function</span> <span class="fn">faireJus</span>(<span class="kw">string</span> <span class="var">$fruit</span>, <span class="kw">int</span> <span class="var">$quantite</span> = <span class="num">1</span>): <span class="kw">string</span> {
    <span class="kw">return</span> <span class="str">"Voici $quantite verre(s) de jus de $fruit"</span>;
}

<span class="c">// Appel</span>
<span class="kw">echo</span> <span class="fn">faireJus</span>(<span class="str">"Pomme"</span>); <span class="c">// Utilise la valeur par d√©faut (1)</span>
<span class="kw">echo</span> <span class="fn">faireJus</span>(<span class="str">"Orange"</span>, <span class="num">3</span>);</pre>
    </div>
</section>

<section>
    <h3>2. Contrat & Responsabilit√©</h3>
    <p>Une fonction raconte une intention. Elle doit √™tre <strong>petite</strong>, <strong>pr√©visible</strong> et
        <strong>facile √† tester</strong>.</p>

    <div class="grid2">
        <div class="ref-card">
            <h4>üß≠ Le Contrat</h4>
            <ul>
                <li>Entr√©e claire (param√®tres explicit√©s).</li>
                <li>Sortie unique et stable.</li>
                <li>Effets visibles et assum√©s.</li>
            </ul>
        </div>
        <div class="ref-card">
            <pre style="background:transparent; border:none; padding:0; font-size:0.7rem;">
[ Entr√©e ] -> ( param√®tres typ√©s )
      |
[ Fonction ] -> { logique }
      |
[ Sortie ] -> return valeur
      </pre>
        </div>
    </div>

    <div class="grid2" style="margin-top:10px;">
        <div class="ref-card">
            <h4>‚úÖ Fonction pure</h4>
            <p>Le m√™me input produit toujours le m√™me output. Id√©ale pour le test et la r√©utilisation.</p>
        </div>
        <div class="ref-card">
            <h4>‚ö° Effet de bord</h4>
            <p>√âcriture fichier, requ√™te SQL, envoi d'email. √Ä isoler pour ma√Ætriser l'impact.</p>
        </div>
    </div>

    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>Contrat.php</div>
        <pre><span class="kw">function</span> <span class="fn">totalPanier</span>(<span class="kw">array</span> <span class="var">$lignes</span>, <span class="kw">float</span> <span class="var">$tva</span>): <span class="kw">float</span> {
    <span class="var">$total</span> = <span class="num">0</span>;
    <span class="kw">foreach</span> (<span class="var">$lignes</span> <span class="kw">as</span> <span class="var">$ligne</span>) {
        <span class="var">$total</span> += <span class="var">$ligne</span>[<span class="str">'prix'</span>] * <span class="var">$ligne</span>[<span class="str">'qty'</span>];
    }
    <span class="kw">return</span> <span class="var">$total</span> * (<span class="num">1</span> + <span class="var">$tva</span>);
}</pre>
    </div>

    <div class="ref-card">
        <h4>üéØ Bonnes pratiques</h4>
        <ul>
            <li>Nommer la fonction par une intention claire (verbe + contexte).</li>
            <li>Limiter le nombre de param√®tres (pr√©f√©rez des tableaux/objets d√©di√©s).</li>
            <li>√âviter la magie globale, passer les d√©pendances en argument.</li>
            <li>Pr√©f√©rer les retours rapides pour r√©duire la complexit√©.</li>
        </ul>
        <button class="example-toggle">Voir une mise en situation</button>
        <div class="example-content">
<pre><span class="var">$lignes</span> = [
    [<span class="str">'prix'</span> => <span class="num">19.9</span>, <span class="str">'qty'</span> => <span class="num">2</span>],
    [<span class="str">'prix'</span> => <span class="num">5</span>, <span class="str">'qty'</span> => <span class="num">1</span>]
];
<span class="var">$total</span> = <span class="fn">totalPanier</span>(<span class="var">$lignes</span>, <span class="num">0.2</span>);
<span class="kw">echo</span> <span class="var">$total</span>;</pre>
        </div>
    </div>
</section>

<section>
    <h3>3. Typage Fort (PHP 8+)</h3>
    <p>PHP moderne permet d'√™tre tr√®s pr√©cis sur ce que la fonction accepte et renvoie. <strong>Indispensable pour la
            s√©curit√©.</strong></p>

    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>Typage.php</div>
        <pre><span class="c">// Union Types (Plusieurs types possibles) |</span>
<span class="kw">function</span> <span class="fn">traiter</span>(<span class="kw">int</span>|<span class="kw">float</span> <span class="var">$num</span>): <span class="kw">void</span> { ... }

<span class="c">// Nullable Types (Peut √™tre NULL) ?</span>
<span class="kw">function</span> <span class="fn">trouverUser</span>(<span class="kw">int</span> <span class="var">$id</span>): ?<span class="kw">array</span> {
    <span class="kw">return</span> <span class="var">$db</span>-><span class="fn">fetch</span>(<span class="var">$id</span>) ?: <span class="kw">null</span>;
}

<span class="c">// Variadics (...$params) : Liste d'arguments infinie</span>
<span class="kw">function</span> <span class="fn">somme</span>(<span class="kw">int</span> ...<span class="var">$nombres</span>): <span class="kw">int</span> {
    <span class="kw">return</span> <span class="fn">array_sum</span>(<span class="var">$nombres</span>);
}
<span class="kw">echo</span> <span class="fn">somme</span>(<span class="num">1</span>, <span class="num">5</span>, <span class="num">10</span>, <span class="num">20</span>); <span class="c">// 36</span></pre>
    </div>

    <div class="grid2" style="margin-top:10px;">
        <div class="ref-card">
            <h4>üß™ Cas d'usage</h4>
            <p>Valider des entr√©es, normaliser des formats, transformer des donn√©es pour l'API.</p>
        </div>
        <div class="ref-card">
            <h4>üß∞ Gardes rapides</h4>
            <p>Retourner t√¥t sur les cas invalides pour garder une fonction lisible.</p>
        </div>
    </div>

    <div class="ref-card" style="margin-top:10px;">
        <h4>üéÆ Mini-simulation</h4>
        <p>Un formulaire envoie parfois un prix vide ou mal format√©.</p>
        <button class="example-toggle">Voir la solution</button>
        <div class="example-content">
<pre><span class="kw">function</span> <span class="fn">nettoyerPrix</span>(?<span class="kw">float</span> <span class="var">$prix</span>): <span class="kw">float</span> {
    <span class="kw">if</span> (<span class="var">$prix</span> === <span class="kw">null</span>) {
        <span class="kw">return</span> <span class="num">0</span>;
    }
    <span class="kw">return</span> <span class="var">$prix</span>;
}
<span class="kw">echo</span> <span class="fn">nettoyerPrix</span>(<span class="kw">null</span>);</pre>
        </div>
    </div>
</section>

<section>
    <h3>4. Fonctions Anonymes & Fl√©ch√©es</h3>
    <p>Utiles pour passer une fonction en argument d'une autre (callbacks).</p>

    <div class="grid2">
        <div class="code">
            <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                    class="dot g"></span>Closure (Classique)</div>
            <pre><span class="var">$facteur</span> = <span class="num">2</span>;
<span class="var">$double</span> = <span class="kw">function</span>(<span class="var">$n</span>) <span class="kw">use</span> (<span class="var">$facteur</span>) {
    <span class="kw">return</span> <span class="var">$n</span> * <span class="var">$facteur</span>;
};</pre>
        </div>
        <div class="code">
            <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                    class="dot g"></span>Arrow Function (PHP 7.4+)</div>
            <pre><span class="var">$facteur</span> = <span class="num">2</span>;
<span class="c">// Capture automatique par valeur</span>
<span class="var">$double</span> = <span class="kw">fn</span>(<span class="var">$n</span>) => <span class="var">$n</span> * <span class="var">$facteur</span>;</pre>
        </div>
    </div>

    <div class="ref-card" style="margin-top:10px;">
        <h4>üß© Cas d'usage fr√©quent</h4>
        <p>Transformer des listes, filtrer des collections, trier des r√©sultats.</p>
        <button class="example-toggle">Voir un pipeline</button>
        <div class="example-content">
<pre><span class="var">$nombres</span> = [<span class="num">1</span>, <span class="num">2</span>, <span class="num">3</span>, <span class="num">4</span>];
<span class="var">$pairs</span> = <span class="fn">array_filter</span>(<span class="var">$nombres</span>, <span class="kw">fn</span>(<span class="var">$n</span>) => <span class="var">$n</span> % <span class="num">2</span> === <span class="num">0</span>);
<span class="var">$doubles</span> = <span class="fn">array_map</span>(<span class="kw">fn</span>(<span class="var">$n</span>) => <span class="var">$n</span> * <span class="num">2</span>, <span class="var">$pairs</span>);
<span class="kw">print_r</span>(<span class="var">$doubles</span>);</pre>
        </div>
    </div>
</section>

<section>
    <h3>5. Concepts Avanc√©s</h3>
    <div class="grid2">
        <div class="ref-card">
            <h4>üîÑ La R√©cursion (Inception)</h4>
            <p>Une fonction qui s'appelle elle-m√™me. Utile pour les structures en arbre (menus, dossiers).</p>
            <p><strong>üö® Attention :</strong> Il faut toujours une "condition de sortie" pour √©viter la boucle infinie
                !</p>
        </div>
        <div class="ref-card">
            <h4>‚öì R√©f√©rence (&)</h4>
            <p>Par d√©faut, PHP passe une <strong>copie</strong>. Avec <code>&</code>, il passe
                l'<strong>original</strong>.</p>
            <code>function boost(&$n) { $n++; }</code>
        </div>
    </div>

    <div class="code" style="margin-top:20px;">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span class="dot g"></span>Premi√®re
            Classe (PHP 8.1+)</div>
        <pre><span class="c">// R√©cup√©rer une fonction comme un objet stable</span>
<span class="var">$maFonction</span> = <span class="fn">strlen</span>(...); 
<span class="kw">echo</span> <span class="var">$maFonction</span>(<span class="str">"Hello"</span>); <span class="c">// 5</span></pre>
    </div>

    <div class="ref-card" style="margin-top:10px;">
        <h4>üß† R√©cursion simple</h4>
        <button class="example-toggle">Voir un exemple</button>
        <div class="example-content">
<pre><span class="kw">function</span> <span class="fn">tailleArbre</span>(<span class="kw">array</span> <span class="var">$noeud</span>): <span class="kw">int</span> {
    <span class="var">$total</span> = <span class="num">1</span>;
    <span class="kw">foreach</span> (<span class="var">$noeud</span>[<span class="str">'enfants'</span>] <span class="kw">as</span> <span class="var">$enfant</span>) {
        <span class="var">$total</span> += <span class="fn">tailleArbre</span>(<span class="var">$enfant</span>);
    }
    <span class="kw">return</span> <span class="var">$total</span>;
}</pre>
        </div>
    </div>
</section>

<div class="warning">
    <strong>‚ö†Ô∏è Global Scope</strong><br>
    En PHP, une variable globale n'est <strong>pas accessible</strong> dans une fonction sans le mot-cl√©
    <code>global</code> (d√©conseill√©) ou sans la passer en param√®tre (recommand√©).
</div>

<div class="tip">
    <strong>üí° Named Arguments (PHP 8)</strong><br>
    Tr√®s utile pour clarifier les appels avec beaucoup d'arguments :<br>
    <code>envoyerMail(dest: $mail, sujet: "Salut", urgent: true);</code>
</div>
