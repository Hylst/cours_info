<div class="sec-header">
    <div class="sec-num">07</div>
    <div>
        <h2 class="sec-title">Gestion des Erreurs & Exceptions</h2>
        <p class="sec-sub">S√©curiser son code contre l'impr√©visible</p>
    </div>
</div>

<div class="intro-box">
    <p>Un bon d√©veloppeur ne code pas seulement pour le "chemin id√©al" (Happy Path). Il pr√©voit ce qui se passe quand
        tout casse : base de donn√©es hors ligne, fichier manquant ou erreur de saisie utilisateur.</p>
</div>

<!-- PARTIE 1 : ERREUR VS EXCEPTION -->
<section>
    <h3>1. Erreur vs Exception : La nuance</h3>
    <div class="grid2">
        <div class="ref-card">
            <h4>üö® L'Erreur (Interne)</h4>
            <p>Elle vient du coeur de PHP. C'est un signal syst√®me (ex: variable oubli√©e, faute de frappe).</p>
            <p><em>Analogie : La fum√©e qui sort du moteur.</em></p>
        </div>
        <div class="ref-card">
            <h4>‚ö†Ô∏è L'Exception (Logique)</h4>
            <p>C'est vous qui la d√©clenchez quand une r√®gle m√©tier est viol√©e (ex: solde bancaire insuffisant).</p>
            <p><em>Analogie : Le d√©tecteur de fum√©e qui sonne.</em></p>
        </div>
    </div>
</section>

<!-- PARTIE 2 : NIVEAUX D'ERREUR -->
<section>
    <h3>2. Les niveaux d'erreurs classiques</h3>
    <p>Toutes les erreurs ne sont pas fatales. PHP les classe par gravit√© :</p>
    <table>
        <tr>
            <th>Niveau</th>
            <th>Impact</th>
            <th>Exemple</th>
        </tr>
        <tr>
            <td><code>E_NOTICE</code></td>
            <td>L√©ger</td>
            <td>Utiliser une variable non d√©finie.</td>
        </tr>
        <tr>
            <td><code>E_WARNING</code></td>
            <td>Moyen</td>
            <td>Inclure un fichier inexistant (<code>include</code>).</td>
        </tr>
        <tr>
            <td><code>E_ERROR</code></td>
            <td>Fatal üíÄ</td>
            <td>Appeler une fonction qui n'existe pas. Arr√™t du script.</td>
        </tr>
        <tr>
            <td><code>E_DEPRECATED</code></td>
            <td>Info</td>
            <td>Utiliser une fonction qui va dispara√Ætre bient√¥t.</td>
        </tr>
    </table>
</section>

<!-- PARTIE 3 : EXCEPTIONS & TRY/CATCH -->
<section>
    <h3>3. Ma√Ætriser le Try / Catch</h3>
    <p>C'est le filet de s√©curit√©. Si une exception est lanc√©e dans le <code>try</code>, PHP saute directement au
        <code>catch</code> sans arr√™ter le site.</p>

    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>TryCatchFinally.php</div>
        <pre><span class="kw">try</span> {
    <span class="c">// 1. Tentative d'action risqu√©e</span>
    <span class="kw">if</span> (!<span class="fn">file_exists</span>(<span class="str">'config.json'</span>)) {
        <span class="kw">throw new</span> <span class="fn">Exception</span>(<span class="str">"Fichier de config introuvable !"</span>);
    }
} <span class="kw">catch</span> (<span class="fn">Exception</span> <span class="var">$e</span>) {
    <span class="c">// 2. R√©cup√©ration du crash</span>
    <span class="kw">echo</span> <span class="str">"D√©sol√©, il y a eu un souci : "</span> . <span class="var">$e</span>-><span class="fn">getMessage</span>();
} <span class="kw">finally</span> {
    <span class="c">// 3. Toujours ex√©cut√© (ex: fermer la BDD)</span>
    <span class="kw">echo</span> <span class="str">"Nettoyage..."</span>;
}</pre>
    </div>
</section>

<!-- PARTIE 4 : PHP 8 MODERNE -->
<section>
    <h3>4. Throw Expression (PHP 8.0+)</h3>
    <p>Avant PHP 8, <code>throw</code> √©tait une instruction. Maintenant, c'est une <strong>expression</strong>. On peut
        l'utiliser partout, m√™me dans des ternaires.</p>

    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>ModernThrow.php</div>
        <pre><span class="c">// Une ligne au lieu d'un bloc IF complet</span>
<span class="var">$id</span> = <span class="var">$_GET</span>[<span class="str">'id'</span>] ?? <span class="kw">throw new</span> <span class="fn">InvalidArgumentException</span>(<span class="str">"ID manquant !"</span>);

<span class="c">// Utilisation dans une Arrow Function</span>
<span class="var">$fn</span> = <span class="kw">fn</span>() => <span class="kw">throw new</span> <span class="fn">Exception</span>();</pre>
    </div>
</section>

<!-- PARTIE 5 : EXCEPTIONS PERSONNALISEES -->
<section>
    <h3>5. Cr√©er ses propres Exceptions</h3>
    <p>Pour mieux organiser vos erreurs, h√©ritez de la classe de base.</p>

    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>CustomException.php</div>
        <pre><span class="kw">class</span> <span class="fn">DatabaseException</span> <span class="kw">extends</span> <span class="fn">Exception</span> {}

<span class="kw">try</span> {
    <span class="c">// ... code BDD</span>
} <span class="kw">catch</span> (<span class="fn">DatabaseException</span> <span class="var">$e</span>) {
    <span class="c">// G√®re seulement les erreurs BDD ici</span>
} <span class="kw">catch</span> (<span class="fn">Exception</span> <span class="var">$e</span>) {
    <span class="c">// G√®re le reste</span>
}</pre>
    </div>
</section>

<section>
    <h3>6. Throwable : la hi√©rarchie r√©elle</h3>
    <p>En PHP moderne, tout ce qui peut √™tre attrap√© h√©rite de <code>Throwable</code>. Les erreurs moteur ne sont pas
        des exceptions classiques, mais elles restent interceptables si vous visez l'interface globale.</p>
    <div class="grid2">
        <div class="ref-card">
            <h4>üß¨ Deux familles</h4>
            <ul>
                <li><strong>Error</strong> : erreurs internes (TypeError, ParseError).</li>
                <li><strong>Exception</strong> : erreurs m√©tier ou applicatives.</li>
                <li><strong>Throwable</strong> : parent commun pour un <code>catch</code> universel.</li>
            </ul>
        </div>
        <div class="ref-card">
            <pre style="background:transparent; border:none; padding:0; font-size:0.7rem;">
Throwable
‚îú‚îÄ‚îÄ Error
‚îÇ   ‚îú‚îÄ‚îÄ TypeError
‚îÇ   ‚îî‚îÄ‚îÄ ParseError
‚îî‚îÄ‚îÄ Exception
    ‚îú‚îÄ‚îÄ RuntimeException
    ‚îî‚îÄ‚îÄ InvalidArgumentException</pre>
        </div>
    </div>
</section>

<section>
    <h3>7. Convertir les erreurs en exceptions</h3>
    <p>Pour un flux homog√®ne, vous pouvez transformer les erreurs PHP en exceptions. Cela √©vite les cas silencieux et
        centralise la gestion.</p>
    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>ErrorToException.php</div>
        <pre><span class="fn">set_error_handler</span>(<span class="kw">function</span>(<span class="var">$severity</span>, <span class="var">$message</span>, <span class="var">$file</span>, <span class="var">$line</span>) {
    <span class="kw">throw new</span> <span class="fn">ErrorException</span>(<span class="var">$message</span>, <span class="num">0</span>, <span class="var">$severity</span>, <span class="var">$file</span>, <span class="var">$line</span>);
});

<span class="fn">error_reporting</span>(<span class="var">E_ALL</span>);</pre>
    </div>
    <div class="ref-card" style="margin-top:10px;">
        <h4>üéØ Alternative</h4>
        <p>Pour certaines fonctions historiques, pr√©f√©rez la v√©rification de retour (ex: <code>file_get_contents</code>)
            et lancez vous-m√™me une exception m√©tier avec un message clair.</p>
    </div>
</section>

<section>
    <h3>8. Gestion globale : exception handler & shutdown</h3>
    <p>Un handler global √©vite le "white screen" et permet de logguer tout crash inattendu, m√™me en dehors des
        <code>try/catch</code>.</p>
    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>GlobalHandlers.php</div>
        <pre><span class="fn">set_exception_handler</span>(<span class="kw">function</span>(<span class="fn">Throwable</span> <span class="var">$e</span>) {
    <span class="fn">error_log</span>(<span class="var">$e</span>-><span class="fn">getMessage</span>());
    <span class="fn">http_response_code</span>(<span class="num">500</span>);
    <span class="kw">echo</span> <span class="str">'Une erreur est survenue.'</span>;
});

<span class="fn">register_shutdown_function</span>(<span class="kw">function</span>() {
    <span class="var">$last</span> = <span class="fn">error_get_last</span>();
    <span class="kw">if</span> (<span class="var">$last</span>) {
        <span class="fn">error_log</span>(<span class="fn">json_encode</span>(<span class="var">$last</span>));
    }
});</pre>
    </div>
</section>

<section>
    <h3>9. Journalisation propre & tra√ßable</h3>
    <p>Ne m√©langez pas affichage et diagnostic. Logguez des donn√©es structur√©es et gardez un message neutre c√¥t√©
        utilisateur.</p>
    <div class="grid2">
        <div class="code">
            <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                    class="dot g"></span>LogConfig.php</div>
            <pre><span class="fn">ini_set</span>(<span class="str">'log_errors'</span>, <span class="str">'1'</span>);
<span class="fn">ini_set</span>(<span class="str">'error_log'</span>, <span class="fn">__DIR__</span> . <span class="str">'/logs/php.log'</span>);</pre>
        </div>
        <div class="code">
            <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                    class="dot g"></span>StructuredLog.php</div>
            <pre><span class="var">$payload</span> = [
    <span class="str">'event'</span> => <span class="str">'payment_failed'</span>,
    <span class="str">'orderId'</span> => <span class="num">42</span>,
    <span class="str">'amount'</span> => <span class="num">99.9</span>
];
<span class="fn">error_log</span>(<span class="fn">json_encode</span>(<span class="var">$payload</span>));</pre>
        </div>
    </div>
</section>

<section>
    <h3>10. Cha√Ænage & rethrow</h3>
    <p>Le cha√Ænage conserve la cause initiale. C'est capital pour d√©boguer sans perdre la trace r√©elle.</p>
    <div class="code">
        <div class="code-head"><span class="dot r"></span><span class="dot y"></span><span
                class="dot g"></span>ExceptionChaining.php</div>
        <pre><span class="kw">try</span> {
    <span class="var">$pdo</span>-><span class="fn">query</span>(<span class="str">'SELECT * FROM missing_table'</span>);
} <span class="kw">catch</span> (<span class="fn">PDOException</span> <span class="var">$e</span>) {
    <span class="kw">throw new</span> <span class="fn">RuntimeException</span>(<span class="str">'√âchec BDD'</span>, <span class="num">0</span>, <span class="var">$e</span>);
}</pre>
    </div>
    <div class="ref-card" style="margin-top:10px;">
        <h4>üîÅ Multi-catch</h4>
        <pre style="background:transparent; border:none; padding:0; font-size:0.7rem;">
try { ... }
catch (InvalidArgumentException|RuntimeException $e) { ... }</pre>
    </div>
</section>

<section>
    <h3>11. Sc√©narios & alternatives de gestion</h3>
    <div class="grid2">
        <div class="ref-card">
            <h4>‚úÖ Fail Fast (Exceptions)</h4>
            <ul>
                <li>Flux clair et lisible.</li>
                <li>Erreurs centralis√©es.</li>
                <li>Parfait pour services et APIs.</li>
            </ul>
        </div>
        <div class="ref-card">
            <h4>üßæ Retour d'erreur (R√©sultat)</h4>
            <ul>
                <li>Utile pour traitements en masse.</li>
                <li>Permet de continuer malgr√© des √©checs.</li>
                <li>N√©cessite un format d'erreur stable.</li>
            </ul>
        </div>
    </div>
    <div class="ref-card" style="margin-top:10px;">
        <h4>üéÆ Mise en situation</h4>
        <p>Importer un CSV o√π seules certaines lignes sont invalides.</p>
        <button class="example-toggle">Voir un sc√©nario</button>
        <div class="example-content">
<pre><span class="var">$errors</span> = [];
<span class="kw">foreach</span> (<span class="var">$rows</span> <span class="kw">as</span> <span class="var">$i</span> => <span class="var">$row</span>) {
    <span class="kw">if</span> (!<span class="fn">filter_var</span>(<span class="var">$row</span>[<span class="str">'email'</span>] ?? <span class="str">''</span>, <span class="var">FILTER_VALIDATE_EMAIL</span>)) {
        <span class="var">$errors</span>[] = <span class="str">'Ligne '</span> . <span class="var">$i</span> . <span class="str">' invalide'</span>;
        <span class="kw">continue</span>;
    }
}</pre>
        </div>
    </div>
</section>

<section>
    <h3>12. Bonnes pratiques & pi√®ges</h3>
    <div class="grid2">
        <div class="ref-card">
            <h4>‚úÖ Bonnes pratiques</h4>
            <ul>
                <li>Utiliser <code>Throwable</code> pour un catch global.</li>
                <li>Cr√©er des exceptions m√©tier explicites.</li>
                <li>Logger avec un identifiant de corr√©lation.</li>
                <li>Envoyer des messages neutres au client.</li>
            </ul>
        </div>
        <div class="ref-card">
            <h4>‚ö†Ô∏è Pi√®ges fr√©quents</h4>
            <ul>
                <li>Masquer les erreurs avec <code>@</code>.</li>
                <li>Attraper trop large sans log.</li>
                <li>Perdre la cause initiale sans cha√Ænage.</li>
                <li>Afficher des chemins en production.</li>
            </ul>
        </div>
    </div>
    <div class="ref-card" style="margin-top:10px;">
        <h4>üßØ R√©ponse HTTP propre</h4>
        <pre style="background:transparent; border:none; padding:0; font-size:0.7rem;">
http_response_code(500);
echo 'Service temporairement indisponible';</pre>
    </div>
</section>

<div class="warning">
    <strong>üõ°Ô∏è S√©curit√© en Production</strong><br>
    N'affichez JAMAIS les erreurs sur votre site public (<code>display_errors = Off</code>). <br>
    Un pirate pourrait utiliser les chemins de fichiers ou les noms de tables affich√©s pour vous attaquer.
</div>

<div class="tip">
    <strong>üí° Astuce D√©bug</strong><br>
    Utilisez <code>error_reporting(E_ALL);</code> au d√©but de vos scripts en d√©veloppement pour √™tre au courant du
    moindre petit oubli.
</div>
