<section id="s8">
    <div class="container">
        <div class="sec-header">
            <div class="sec-num">08</div>
            <div>
                <h2 class="sec-title">Async & WebSockets : Le Temps R√©el</h2>
                <p class="sec-sub">Du parall√©lisme avec AsyncIO √† la communication Full-Duplex</p>
            </div>
        </div>

        <div class="intro-box"
            style="margin-bottom: 30px; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
            <p>Le web moderne ne se limite plus au cycle "Requ√™te / R√©ponse". Avec l'asynchronisme
                (<code>asyncio</code>) et les <strong>WebSockets</strong>, Python peut g√©rer des flux de donn√©es en
                temps r√©el (chats, dashboards live, jeux) sans bloquer ses ressources syst√®mes.</p>
        </div>

        <div class="grid2">
            <div>
                <h3>1. L'Event Loop & asyncio</h3>
                <p>Au lieu de cr√©er un thread par utilisateur (co√ªteux), Python utilise une <strong>Boucle
                        d'√âv√©nements</strong>. Quand une t√¢che attend (ex: lecture DB), le serveur passe instantan√©ment
                    √† la suivante.</p>
                <div class="mermaid" style="background: var(--bg2); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    graph LR
                    Loop["Event Loop"] --> T1["T√¢che 1: I/O Wait"]
                    Loop --> T2["T√¢che 2: Calcul"]
                    T1 -.->|Pause / yield| Loop
                    Loop --> T3["T√¢che 3: Response"]
                </div>
            </div>
            <div>
                <h3>2. WebSockets vs HTTP</h3>
                <p>Alors que l'HTTP ferme la connexion apr√®s chaque r√©ponse, le WebSocket maintient un <strong>tunnel
                        ouvert</strong> et bidirectionnel.</p>
                <div class="mermaid" style="background: var(--bg2); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    sequenceDiagram
                    participant C as Client
                    participant S as Serveur
                    C->>S: Upgrade Request (HTTP)
                    S-->>C: 101 Switching Protocols
                    Note over C,S: Connexion Persistante (TCP)
                    C->>S: Data (JSON/Binary)
                    S->>C: Data (Push temps r√©el)
                    C->>S: Data
                </div>
            </div>
        </div>

        <h3 style="margin-top:40px">3. Impl√©mentation avec FastAPI</h3>
        <div class="code">
            <div class="code-head"><span class="dot g"></span>websocket_server.py</div>
            <pre><span class="kw">from</span> fastapi <span class="kw">import</span> FastAPI, WebSocket

<span class="var">app</span> = <span class="cls">FastAPI</span>()

<span class="dec">@app.websocket</span>(<span class="str">"/ws/{client_id}"</span>)
<span class="kw">async def</span> <span class="fn">websocket_endpoint</span>(<span class="var">websocket</span>: <span class="cls">WebSocket</span>, <span class="var">client_id</span>: <span class="cls">int</span>):
    <span class="kw">await</span> <span class="var">websocket</span>.<span class="fn">accept</span>()
    <span class="kw">try</span>:
        <span class="kw">while True</span>:
            <span class="var">data</span> = <span class="kw">await</span> <span class="var">websocket</span>.<span class="fn">receive_text</span>()
            <span class="c"># Push de donn√©es au client sans qu'il demande</span>
            <span class="kw">await</span> <span class="var">websocket</span>.<span class="fn">send_text</span>(<span class="str">f"Message re√ßu : </span>{<span class="var">data</span>}<span class="str">"</span>)
    <span class="kw">except</span> <span class="cls">Exception</span>:
        <span class="fn">print</span>(<span class="str">"Client d√©connect√©"</span>)</pre>
        </div>

        <h3 style="margin-top:40px">4. Cas d'Usage & √âcosyst√®me</h3>
        <div class="grid3">
            <div class="ref-card">
                <h4>üì° Broadcasting</h4>
                <p>Envoyer un message √† tous les utilisateurs connect√©s simultan√©ment (ex: notification syst√®me).</p>
            </div>
            <div class="ref-card">
                <h4>‚è±Ô∏è Basse Latence</h4>
                <p>Id√©al pour le trading ou les collaborations en direct (type Google Docs) o√π chaque ms compte.</p>
            </div>
            <div class="ref-card">
                <h4>üîå Alternatives</h4>
                <p><strong>Socket.io</strong> (couche au-dessus de WS pour la reconnexion auto) ou <strong>Server-Sent
                        Events (SSE)</strong> pour du push unidirectionnel.</p>
            </div>
        </div>

        <div class="info"
            style="margin-top: 30px; border-left: 4px solid var(--blue); background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 4px;">
            <strong>‚ö†Ô∏è Note sur le D√©ploiement</strong>
            <p>Les WebSockets n√©cessitent un serveur compatible ASGI (comme <strong>Uvicorn</strong> ou
                <strong>Daphne</strong>) et une configuration sp√©cifique de Nginx
                (<code>proxy_set_header Upgrade $http_upgrade;</code>) pour ne pas couper la connexion.
            </p>
        </div>

        <details style="margin-top: 30px;">
            <summary>‚ûï Syntaxe Moderne : async with & await</summary>
            <div class="code" style="margin-top: 15px;">
                <div class="code-head"><span class="dot b"></span>HTTP Client Asynchrone (Hittpx)</div>
                <pre><span class="kw">import</span> httpx
<span class="kw">import</span> asyncio

<span class="kw">async def</span> <span class="fn">fetch_data</span>():
    <span class="kw">async with</span> <span class="var">httpx</span>.<span class="cls">AsyncClient</span>() <span class="kw">as</span> <span class="var">client</span>:
        <span class="var">resp</span> = <span class="kw">await</span> <span class="var">client</span>.<span class="fn">get</span>(<span class="str">"https://api.example.com"</span>)
        <span class="kw">return</span> <span class="var">resp</span>.<span class="fn">json</span>()

<span class="c"># Lancer plusieurs requ√™tes en parall√®le</span>
<span class="var">results</span> = <span class="kw">await</span> <span class="var">asyncio</span>.<span class="fn">gather</span>(<span class="fn">fetch_data</span>(), <span class="fn">fetch_data</span>())</pre>
            </div>
        </details>
    </div>
</section>