<section id="s9">
    <div class="container">
        <div class="sec-header">
            <div class="sec-num">09</div>
            <div>
                <h2 class="sec-title">Background Tasks : D√©l√©guer pour la Performance</h2>
                <p class="sec-sub">Optimiser l'exp√©rience utilisateur en d√©chargeant les op√©rations lourdes</p>
            </div>
        </div>

        <div class="intro-box"
            style="margin-bottom: 30px; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
            <p>Dans une application web, la r√®gle d'or est la <strong>r√©activit√©</strong>. Si une action prend plus de
                200ms (envoi d'email, g√©n√©ration de PDF, calcul IA), elle ne doit pas bloquer la requ√™te HTTP. La
                solution : le pattern <strong>Producteur-Consommateur</strong>.</p>
        </div>

        <div class="grid2">
            <div>
                <h3>1. Architecture Distribu√©e</h3>
                <p>L'application (Producteur) envoie un message dans une file d'attente (Broker). Un processus s√©par√©
                    (Worker) r√©cup√®re ce message et l'ex√©cute en arri√®re-plan.</p>
                <div class="mermaid" style="background: var(--bg2); padding: 15px; border-radius: 8px; margin: 15px 0;">
                    graph LR
                    App["App Web"] -->|1. Envoie T√¢che| B[("Broker: Redis / RMQ")]
                    B -->|2. Pull| W["Worker: Celery"]
                    W -->|3. Ex√©cute| Job["Email / Image / PDF"]
                    Job -.->|4. Stocke R√©sultat| DB[("Base de Donn√©es / Cache")]
                </div>
            </div>
            <div>
                <h3>2. Strat√©gies de D√©l√©gation</h3>
                <div class="grid2">
                    <div class="ref-card" style="border-left: 4px solid var(--blue);">
                        <h4>‚ö° Solution L√©g√®re</h4>
                        <p><strong>FastAPI BackgroundTasks</strong> : Ex√©cution dans le m√™me processus apr√®s la r√©ponse.
                            Simple, id√©al pour les emails rapides.</p>
                    </div>
                    <div class="ref-card" style="border-left: 4px solid var(--red);">
                        <h4>üèóÔ∏è Solution Robuste</h4>
                        <p><strong>Celery / Dramatiq</strong> : Processus isol√©s, gestion des retries, monitoring,
                            scheduling (Crontab).</p>
                    </div>
                </div>
            </div>
        </div>

        <h3 style="margin-top:40px">3. Comparatif Technique</h3>
        <div class="grid2">
            <div class="code">
                <div class="code-head"><span class="dot g"></span>In-Process (FastAPI)</div>
                <pre><span class="kw">from</span> fastapi <span class="kw">import</span> BackgroundTasks

<span class="dec">@app.post</span>(<span class="str">"/report"</span>)
<span class="kw">async def</span> <span class="fn">generate_report</span>(<span class="var">bg</span>: <span class="cls">BackgroundTasks</span>):
    <span class="c"># S'ex√©cute APRES le return</span>
    <span class="var">bg</span>.<span class="fn">add_task</span>(<span class="fn">big_calculation</span>)
    <span class="kw">return</span> {<span class="str">"status"</span>: <span class="str">"En cours"</span>}</pre>
            </div>
            <div class="code">
                <div class="code-head"><span class="dot r"></span>Distributed (Celery)</div>
                <pre><span class="kw">from</span> celery <span class="kw">import</span> Celery

<span class="var">app</span> = <span class="cls">Celery</span>(broker=<span class="str">"redis://..."</span>)

<span class="at">@app</span>.<span class="fn">task</span>
<span class="kw">def</span> <span class="fn">heavy_task</span>(<span class="var">x</span>):
    <span class="kw">return</span> <span class="var">x</span> ** <span class="num">2</span>

<span class="c"># Appel imm√©diat, r√©ponse non bloqu√©e</span>
<span class="fn">heavy_task</span>.<span class="fn">delay</span>(<span class="num">10</span>)</pre>
            </div>
        </div>

        <h3 style="margin-top:40px">4. Monitoring & Fiabilit√©</h3>
        <p>Plus vous avez de t√¢ches de fond, plus vous avez besoin de visibilit√© sur leur √©tat (√©chec, succ√®s, temps
            d'ex√©cution).</p>
        <div class="grid3">
            <div class="ref-card">
                <h4>Flower üå∏</h4>
                <p>L'interface web standard pour monitorer Celery en temps r√©el (files, workers, taux d'erreur).</p>
            </div>
            <div class="ref-card">
                <h4>Retries üîÑ</h4>
                <p>Celery permet de re-tenter automatiquement une t√¢che si une API tierce est temporairement
                    indisponible.</p>
            </div>
            <div class="ref-card">
                <h4>Beat ‚è≤Ô∏è</h4>
                <p>Le planificateur de Celery pour ex√©cuter des t√¢ches √† intervalle r√©gulier (ex: stats tous les lundis
                    √† 8h).</p>
            </div>
        </div>

        <div class="info"
            style="margin-top: 30px; border-left: 4px solid var(--purple); background: rgba(168, 85, 247, 0.1); padding: 15px; border-radius: 4px;">
            <strong>üí° Tip: Redis vs RabbitMQ</strong>
            <p><strong>Redis</strong> est parfait pour d√©buter (simple, rapide, souvent d√©j√† l√† pour le cache).
                <strong>RabbitMQ</strong> est plus robuste pour des millions de messages avec des routages complexes.
            </p>
        </div>

        <details style="margin-top: 30px;">
            <summary>‚ûï Alternatives Modernes</summary>
            <div class="grid2" style="margin-top: 15px;">
                <div class="ref-card">
                    <h4>Dramatiq</h4>
                    <p>Une alternative √† Celery qui se veut plus simple, avec moins de configuration et des erreurs plus
                        claires.</p>
                </div>
                <div class="ref-card">
                    <h4>ARQ / SAQ</h4>
                    <p>Des biblioth√®ques bas√©es sur Redis et <code>asyncio</code>, parfaites si votre projet est d√©j√†
                        100% asynchrone.</p>
                </div>
            </div>
        </details>
    </div>
</section>