(function(){"use strict";function A(g,s){return s.reduce((f,c,l)=>{const t=g.r-c.r,i=g.g-c.g,n=g.b-c.b,e=t*t+i*i+n*n;return e<f.distance?{index:l,distance:e}:f},{index:0,distance:1/0}).index}const R=32034,_=34,v=40,O=8e3;self.onmessage=async g=>{const{imageData:s,width:f,height:c,ditherLevel:l=0,optimizePalette:t=!0,customPalette:i,fromPI1:n=!1}=g.data,e=new Uint8Array(s);let a=[];i?a=i:n?a=U(e):t?a=B(e,f,c):a=I();const M=new Uint8Array(R);M[0]=0,M[1]=0;for(let r=0;r<16;r++){const o=a[r],d=Math.round(o.r/255*7)&7,P=Math.round(o.g/255*7)&7,y=Math.round(o.b/255*7)&7,p=d<<8|P<<4|y;M[2+r*2]=p>>8&255,M[2+r*2+1]=p&255}const h=new Uint8Array(32e3),u=new Uint8ClampedArray(320*200*4),b=l>0?L(e,f,c,a,l/10):e;for(let r=0;r<200;r++)for(let o=0;o<320;o++){let d=0;if(o<f&&r<c){const x=(r*f+o)*4,D={r:b[x],g:b[x+1],b:b[x+2]};d=A(D,a)}const P=Math.floor(o/8),y=7-o%8;for(let x=0;x<4;x++){const D=x*O,w=r*v;d&1<<x&&(h[D+w+P]|=1<<y)}const p=(r*320+o)*4,E=a[d];u[p]=E.r,u[p+1]=E.g,u[p+2]=E.b,u[p+3]=255}M.set(h,_);const m={header:{resolution:0,palette:a},data:M,width:320,height:200,imageData:new ImageData(u,320,200)};self.postMessage(m)};function U(g){const s=[];for(let f=0;f<16;f++){const c=g[2+f*2]<<8|g[2+f*2+1],l=(c>>8&7)*255/7,t=(c>>4&7)*255/7,i=(c&7)*255/7;s.push({r:l,g:t,b:i})}return s}function I(){return[{r:0,g:0,b:0},{r:255,g:255,b:255},{r:255,g:0,b:0},{r:0,g:255,b:0},{r:0,g:0,b:255},{r:255,g:255,b:0},{r:255,g:0,b:255},{r:0,g:255,b:255},{r:128,g:128,b:128},{r:192,g:192,b:192},{r:128,g:0,b:0},{r:0,g:128,b:0},{r:0,g:0,b:128},{r:128,g:128,b:0},{r:128,g:0,b:128},{r:0,g:128,b:128}]}function B(g,s,f){const c=[];for(let n=0;n<f;n++)for(let e=0;e<s;e++){const a=(n*s+e)*4;g[a+3]>128&&c.push({r:g[a],g:g[a+1],b:g[a+2]})}if(c.length<16)return I();const l=C(c,16);let t=!1,i=!1;for(const n of l)n.r===0&&n.g===0&&n.b===0&&(t=!0),n.r===255&&n.g===255&&n.b===255&&(i=!0);return t||(l[0]={r:0,g:0,b:0}),i||(l[1]={r:255,g:255,b:255}),l.map(n=>({r:Math.round(Math.round(n.r/255*7)*255/7),g:Math.round(Math.round(n.g/255*7)*255/7),b:Math.round(Math.round(n.b/255*7)*255/7)}))}function C(g,s){if(g.length===0)return I();const f=n=>{let e=0,a=0,M=0;for(const h of n)e+=h.r,a+=h.g,M+=h.b;return{r:Math.round(e/n.length),g:Math.round(a/n.length),b:Math.round(M/n.length)}},c=n=>{let e=255,a=0,M=255,h=0,u=255,b=0;for(const d of n)e=Math.min(e,d.r),a=Math.max(a,d.r),M=Math.min(M,d.g),h=Math.max(h,d.g),u=Math.min(u,d.b),b=Math.max(b,d.b);const m=a-e,r=h-M,o=b-u;return m>=r&&m>=o?"r":r>=m&&r>=o?"g":"b"},l=(n,e)=>{if(n.length===0)return[];if(e===0||n.length===1)return[f(n)];const a=c(n);n.sort((b,m)=>b[a]-m[a]);const M=Math.floor(n.length/2),h=n.slice(0,M),u=n.slice(M);return[...l(h,e-1),...l(u,e-1)]},t=Math.ceil(Math.log2(s)),i=l(g,t);if(i.length>s&&(i.length=s),i.length<s){const n=I();for(let e=i.length;e<s;e++)i.push(n[e])}return i}function L(g,s,f,c,l){const t=new Uint8Array(g.length);t.set(g);for(let i=0;i<f;i++)for(let n=0;n<s;n++){const e=(i*s+n)*4,a={r:t[e],g:t[e+1],b:t[e+2]},M=A(a,c),h=c[M];t[e]=h.r,t[e+1]=h.g,t[e+2]=h.b;const u=(a.r-h.r)*l,b=(a.g-h.g)*l,m=(a.b-h.b)*l;if(n+1<s){const r=e+4;t[r]=Math.min(255,Math.max(0,t[r]+u*7/16)),t[r+1]=Math.min(255,Math.max(0,t[r+1]+b*7/16)),t[r+2]=Math.min(255,Math.max(0,t[r+2]+m*7/16))}if(i+1<f){if(n>0){const o=e+s*4-4;t[o]=Math.min(255,Math.max(0,t[o]+u*3/16)),t[o+1]=Math.min(255,Math.max(0,t[o+1]+b*3/16)),t[o+2]=Math.min(255,Math.max(0,t[o+2]+m*3/16))}const r=e+s*4;if(t[r]=Math.min(255,Math.max(0,t[r]+u*5/16)),t[r+1]=Math.min(255,Math.max(0,t[r+1]+b*5/16)),t[r+2]=Math.min(255,Math.max(0,t[r+2]+m*5/16)),n+1<s){const o=e+s*4+4;t[o]=Math.min(255,Math.max(0,t[o]+u*1/16)),t[o+1]=Math.min(255,Math.max(0,t[o+1]+b*1/16)),t[o+2]=Math.min(255,Math.max(0,t[o+2]+m*1/16))}}}return t}})();
